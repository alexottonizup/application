name: Create Release Tag on Main

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write

jobs:
  create-release-tag:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install --save-dev semantic-release @semantic-release/exec

      - name: Extract version from branch name
        id: version
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          # Extrai vers√£o da branch release/1.1.0-RELEASE
          VERSION=$(echo "$BRANCH_NAME" | grep -oP 'release/\K[0-9]+\.[0-9]+\.[0-9]+')
          
          if [ -z "$VERSION" ]; then
            echo "‚ö†Ô∏è Could not extract version from branch name, using semantic-release"
            npx semantic-release --dry-run > output.log 2>&1 || true
            VERSION=$(grep -oP 'Published release \K[0-9]+\.[0-9]+\.[0-9]+' output.log | tail -1)
          fi
          
          if [ -z "$VERSION" ]; then
            VERSION="1.0.0"
            echo "‚ö†Ô∏è Using fallback version: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Release version: $VERSION"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update version in package.json
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          if [ -f "package.json" ]; then
            npm version "$VERSION" --no-git-tag-version --allow-same-version
            git add package.json
            git commit -m "chore: release version $VERSION [skip ci]" || echo "No changes to commit"
            git push origin main
          fi

      - name: Create Git Tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="v${VERSION}"
          
          # Verifica se a tag j√° existe
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Tag $TAG_NAME j√° existe"
            exit 0
          fi
          
          echo "‚ú® Criando tag $TAG_NAME"
          git tag -a "$TAG_NAME" -m "Release version $VERSION"
          git push origin "$TAG_NAME"
          
          echo "‚úÖ Tag $TAG_NAME criada com sucesso!"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="v${VERSION}"
          
          # Gera changelog dos commits desde a √∫ltima tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          gh release create "$TAG_NAME" \
            --title "Release $VERSION" \
            --notes "## üöÄ Release $VERSION

          ### üìã Changelog
          $CHANGELOG

          ---
          **Data:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Branch:** main" \
            --repo ${{ github.repository }}

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="v${VERSION}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          gh pr comment "$PR_NUMBER" --body "üéâ **Release publicada com sucesso!**

          üì¶ **Vers√£o:** \`$VERSION\`
          üè∑Ô∏è **Tag:** \`$TAG_NAME\`
          üîó **Release:** https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME

          ‚úÖ A vers√£o foi publicada em produ√ß√£o."