name: Auto Version & PR (develop to release)

on:
  push:
    branches:
      - develop

jobs:
  version-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Busca todo o hist√≥rico

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install --save-dev semantic-release @semantic-release/exec

      - name: Get next version with semantic-release
        id: semantic
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          npx semantic-release --dry-run > output.log || true
          VERSION=$(grep -oP 'Published release \K[0-9]+\.[0-9]+\.[0-9]+' output.log | tail -1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check if there are commits to release
        id: check_commits
        run: |
          # Busca as branches remotas
          git fetch origin develop:develop
          git fetch origin release:release || git checkout -b release
          
          # Verifica se h√° commits diferentes
          COMMITS=$(git log release..develop --oneline | wc -l)
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          
          if [ "$COMMITS" -eq 0 ]; then
            echo "‚ö†Ô∏è No commits to release. Skipping PR creation."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Found $COMMITS commits to release."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request to release
        if: steps.check_commits.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          VERSION="${{ steps.semantic.outputs.version }}"
          BRANCH="develop"
          
          # Verifica se PR j√° existe
          PR_NUMBER=$(gh pr list --head "$BRANCH" --base release --json number --jq '.[0].number' 2>/dev/null || echo "")
          
          if [ -z "$PR_NUMBER" ]; then
            echo "‚ú® Creating new PR..."
            gh pr create \
              --title "Release v$VERSION-RC" \
              --body "## üöÄ Automated PR - Develop to Release
          
          **Version:** \`$VERSION-RC\`
          **Branch:** \`$BRANCH\`
          **Target:** \`release\`
          **Created:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ---
          
          ### üìã Changes
          This PR delivers the development branch to the release candidate environment.
          
          ### ‚úÖ Checklist
          - [ ] Code reviewed
          - [ ] Tests passing
          - [ ] Documentation updated" \
              --base release \
              --head "$BRANCH" || echo "‚ö†Ô∏è PR creation failed"
          else
            echo "üîÑ PR #$PR_NUMBER already exists, updating..."
            gh pr edit "$PR_NUMBER" \
              --title "Release v$VERSION-RC" || echo "‚ö†Ô∏è PR update failed"
          fi